{#   Join TACWA - Organization Information   #}

{% extends "_layouts/_base" %}
{% import '_macros/global' as global %}
{% import '_macros/forms' as form %}

{% set baseUrlSegments = 1 %}
{% set segment1 = craft.app.request.segment(baseUrlSegments + 1) %}
{% set segment2 = craft.app.request.segment(baseUrlSegments + 2) %}

{# {% requireLogin %} #}
{% if not craft.session.isLoggedIn %}
{% redirect "/event-registration/" ~ segment2 %}
{% endif %}



{% block content %}

   {#   Page Header   #}
   {% include '_components/static/page-header'
      with {
         'type': 'border',
         'heading': 'Event Registration'
      }
   %}
   
			
	{% set successParam = craft.app.request.getParam('success') %}
	{% if successParam is not null %}
	
	<div class="form-flow  |  container">
	  Thanks, we have received your registration!
	</div>
	  
	{% else %}
   
   {% set eventId = segment2 %}
   {% if eventId %}
   		{% set event = craft.calendar.event(eventId) %}
	{% endif %}
	
   {% if event is not defined or event is empty %}
	  {% redirect "events" %}

	{% else %}
	
	
    {% set submissions = craft.freeform.submissions({
	    	form: 'eventRegistrationMember'
	    }) %}
	{% set registered = false %}
    {% for submission in submissions if not registered %}
	    {% if submission.user == currentUser.id and submission.eventId == eventId %}
		    {% set registered = true %}
	    {% endif %}
    {% endfor %}
	
	{% set eventPrice = (event.memberPrice > 0) ? event.memberPrice : 0 %}
   
	<div class="form-flow  |  container">
		<div class="form-flow__wrapper --reverse">		
			
			<div class="form-flow__detail">
				<h3 class="heading --tiny  |  text-teal">Your Order</h3>
				<p class="form-flow__detail__description"><a href="/event/{{ event.slug }}" class="link">{{ event.title }}</a> - Member Registration</p>
				<p class="form-flow__detail__total">Total: {{ (eventPrice > 0) ? '$' ~ eventPrice : 'FREE' }}</p>
			</div>
			
    
			{% if registered %}
			
			<h3>You are already registered for this event.</h3>
			
			{% else %}
    
			
			{{ craft.freeform.form("eventRegistrationMember", {
			  labelClass: "form-label",
			  inputClass: "form-control",
			  overrideValues: {
			    firstName: currentUser.firstName,
				lastName: currentUser.lastName,
				email: currentUser.email,
				companyName: craft.entries.organization,
				eventId: eventId,
				event: eventId,
				calendarEvent: event.title,
				eventCostMember: eventPrice,
				phone: currentUser.phone,
				user: currentUser.id
			  }
			}).render() }}
			
			{% endif %}

			 
		</div>
	</div>
   {% endif %}
	
	
	{% endif %}

{% endblock %}